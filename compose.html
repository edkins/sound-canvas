<html>
	<head>
		<meta charset="utf-8">
	</head>
	<script>
'use strict';
const f_hz = 440 * Math.pow(2, -4/12);
const mode_names = ['Lyd.','Major','Mix.','Dor.','Minor','Phr.'];
const note_names = ['C♭','G♭','D♭','A♭','E♭','B♭','F','C','G','D','A','E','B','F♯','C♯','G♯','D♯','A♯','E♯'];
const lyd_scale_fifths = [0, 2, 4, 6, 1, 3, 5];
let key_sig = undefined;
let key_mode = undefined;
const max_pitch = 48;

function box(svg, x, y, w, h, fill, label) {
	return multibox(svg, x, y, w, h, fill, [{label,x:0,y:0}]);
}

function multibox(svg, x, y, w, h, fill, labels) {
	const rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
	rect.setAttribute('x', x);
	rect.setAttribute('y', y);
	rect.setAttribute('width', w);
	rect.setAttribute('height', h);
	rect.setAttribute('fill', fill);
	rect.setAttribute('stroke', '#000');
	svg.appendChild(rect);

	for (const label of labels) {
		const text = document.createElementNS('http://www.w3.org/2000/svg','text');
		text.setAttribute('x', x + w / 2 + label.x);
		text.setAttribute('y', y + h / 2 + label.y);
		text.setAttribute('dominant-baseline', 'central');
		text.setAttribute('text-anchor', 'middle');
		text.setAttribute('fill', '#000');
		text.setAttribute('pointer-events', 'none');
		text.textContent = label.label;
		svg.appendChild(text);
	}

	return rect;
}

function key_note_name(sig, mode) {
	return note_names[6 + sig + mode];
}

// sorry these are so ugly

function scale_note_name(sig, mode, n) {
	let n_mod7 = ((n + (4 * mode) % 7) + 7) % 7;
	return note_names[6 + sig + lyd_scale_fifths[n_mod7]];
}

function scale_note_pitch(sig, mode, n) {
	let n_mod7 = ((n + (4 * mode) % 7) + 7) % 7;
	let t_mod7 = ((0 + (4 * mode) % 7) + 7) % 7;
	let pitch_class = (12 + (sig + lyd_scale_fifths[n_mod7]) * 7) % 12;
	let t_class     = (12 + (sig + lyd_scale_fifths[t_mod7]) * 7) % 12;
	let octave = Math.floor((n + 0.01) / 7);
	if (t_class > pitch_class) {
		octave++;
	}
	return pitch_class + octave * 12;
}

function init_key_menu() {
	const svg = document.getElementById('key-menu');
	const w = 60;
	const h = 45;
	box(svg, 0, 0, w, h, '#fff', 'Key sig');
	for (let mode = 0; mode <= 5; mode++) {
		let fill = '#fff';
		if (mode === 1) {
			fill = '#fdd';
		} else if (mode === 4) {
			fill = '#cdf';
		}
		box(svg, (mode + 1) * w, 0, w, h, fill, mode_names[mode]);
	}
	for (let sig = -6; sig <= 6; sig++) {
		let labels = [];
		const sharp_ys = [3, 0, 4, 1, -2, 2, -1];
		const flat_ys = [0, 3, -1, 2, -2, 1];
		for (let i = 0; i < Math.abs(sig); i++) {
			if (sig < 0) {
				labels.push({
					label: '♭',
					x: i * 8 - 20,
					y: -flat_ys[i] * 4
				});
			} else {
				labels.push({
					label: '♯',
					x: i * 8 - 20,
					y: -sharp_ys[i] * 4
				});
			}
			
		}
		multibox(svg, 0, (7 - sig) * h, w, h, '#fff', labels);

		for (let mode = 0; mode <= 5; mode++) {
			let fill = '#fff';
			if (mode === 1) {
				fill = '#fff4f4';
			} else if (mode === 4) {
				fill = '#f4f8ff';
			}
			let rect = box(svg, (mode + 1) * w, (7 - sig) * h, w, h, fill, key_note_name(sig, mode));
			rect.dataset.mode = mode;
			rect.dataset.sig = sig;
			rect.onclick = click_key;
		}
	}
}

function init_main() {
	const svg = document.getElementById('scale');
	const max_n = Math.ceil(max_pitch * 7 / 12) + 5; // should be enough labels
	for (let n = 0; n < max_n; n++) {
		const x = 0;
		
		const text = document.createElementNS('http://www.w3.org/2000/svg','text');
		text.setAttribute('x', x);
		text.setAttribute('y', 0); // set later
		text.setAttribute('font-size', 13);
		text.textContent = '';   // will be filled in later

		svg.appendChild(text);
	}
}

function init() {
	init_key_menu();
	init_main();
	update_display();
}

function update_display() {
	const key_menu = document.getElementById('key-menu');
	const main = document.getElementById('main');
	const scale = document.getElementById('scale');

	if (key_sig === undefined || key_mode === undefined) {
		key_menu.classList.remove('hidden');
		main.classList.add('hidden');
	} else {
		key_menu.classList.add('hidden');
		main.classList.remove('hidden');
		document.getElementById('key-name').textContent = 'Key: ' + key_note_name(key_sig, key_mode) + ' ' + mode_names[key_mode];
		let text_index = 0;
		let texts = scale.getElementsByTagName('text');
		let n = -6;
		while (true) {
			const pitch = scale_note_pitch(key_sig, key_mode, n);
			if (pitch >= max_pitch) {
				break;
			}
			if (pitch >= 0) {
				const text = texts[text_index];
				text_index++;
				const y = 750 - 13 * pitch;
				const label = scale_note_name(key_sig, key_mode, n);
				text.setAttribute('y', y);
				text.textContent = label;
				text.classList.remove('hidden');
			}
			n++;
		}
		while (text_index < texts.length) {
			const text = texts[text_index];
			text.classList.add('hidden');
			text_index++;
		}
	}
}

function click_key(e) {
	key_mode = parseInt(e.target.dataset.mode);
	key_sig = parseInt(e.target.dataset.sig);
	update_display();
}

window.onload = init;

	</script>
<style>
.hidden {
	display: none;
}
</style>
	<body>
		<svg width="1000" height="750" style="background:#eee" id="svg">
			<g id="key-menu"/>
			<g id="main">
				<text id="key-name" x="0" y="20"></text>
				<g id="scale"/>
			</g>
		</svg>
	</body>
</html>
